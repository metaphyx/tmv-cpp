#summary Instructions for installing TMV using SCons

= Installing using SCons =

With the version 0.62 release of TMV, I introduced a new installation method using SCons.  
For that 
release it was considered an alternative method, since it was brand new.  However, by now, I
have tried it on quite a few platforms and it seems to be working very well.  It usually finds
the BLAS and LAPACK libraries on your system automatically, which is nicer than having 
to specify them by hand.

If you have trouble installing with SCons, you can try the 
[Make_Installation Makefile installation] instead.  And please let me know about 
the problem you are having either at [http://groups.google.com/group/tmv-discuss TMV Discuss] or [http://code.google.com/p/tmv-cpp/issues Issues].

=== 1. Make sure you have SCons installed on your system.  ===
It is available for free from [http://www.scons.org/].  (It is a very quick installation if you have Python installed.)

=== 2. Build the TMV library ===
Type 
{{{
scons
}}}
This will make the libraries `libtmv.a` and `libtmv_symband.a`
and put them into the directory `lib`.  Like with `make`, you can add
the flag `-j4` to use 4 (or whatever number of) compilers simultaneously.
Also, the command `scons -h` will print some help information, and `scons -H`
will print information about the options specific to TMV.

=== 3. Options ===
There are a number of command-line options that you might need (but try it with no flags
first -- it can often find everything automatically).  
The options are listed 
with their default value.  You change them simply by specifying a different value
on the command line.  For example:
{{{
scons CXX=icpc INST_LONGDOUBLE=true
}}}
If you need to run SCons multiple times (for example to compile the test suite or install the libraries as described below), you only need to specify the new parameter values the first time you run SCons. The program automatically saves your options and continues to use them until you change a value again.

    * `CXX=g++` specifies which C++ compiler to use.
    * `FLAGS=''` specifies the basic flags to pass to the compiler.  The default behavior is to automatically choose good flags to use according to which kind of compiler you are using. It has defaults for `g++`, `icpc` and `pgCC`.  If you are using a different compiler or don't like the default, then you can specify this by hand.   Remember to put the flags in quotes, so the whitespace doesn't confuse the parser.  e.g. `scons FLAGS='-O3 -g'`
    * `DEBUG=false` specifies whether to keep the debugging assert statements in the compiled library code.  
    * `PREFIX=/usr/local` specifies where to install the library when running `scons install` (see below).
    * `INST_FLOAT=true` specifies whether to instantiate the `<float>` templates.
    * `INST_DOUBLE=true` specifies whether to instantiate the `<double>` templates.
    * `INST_LONGDOUBLE=false` specifies whether to instantiate the `<long double>` templates.
    * `INST_INT=false` specifies whether to instantiate the `<int>` templates.
    * `WITH_OPENMP=true` specifies whether to use OpenMP to parallelize some parts of the code.

The next flags set up the paths that SCons will use to try to find your BLAS and LAPACK libraries.
    * `IMPORT_ENV=false` specifies whether to import the entire environment from the calling shell. The default is to start with a clean environment to be less susceptible to a particular user having an unusual set up.  But sometimes sysadmins set things up in non-standard ways and use the environment variables to make everything work.  If this is the case, then  `IMPORT_ENV` should do the trick.  It imports the environment, but doe not add any `-I` or `-L` flags when compiling.
    * `EXTRA_PATH=''` specifies directories in which to search for executables (notably the compiler, although you can also just give the full path in the `CXX` parameter) in addition to the standard locations such as `/usr/bin` and `/usr/local/bin`. If you are giving multiple directories, they should be separated by colons.
    * `EXTRA_INCLUDE_PATH=''` specifies directories in which to search for header files (such as the BLAS or LAPACK header files) in addition to the standard locations such as `/usr/include` and `/usr/local/include`. These directories are specified as `-I` flags to the compiler. If you are giving multiple directories, they should be separated by colons.
    * `EXTRA_LIB_PATH=''` specifies directories in which to search for libraries (such as the BLAS or LAPACK libraries) in addition to the standard locations such as `/usr/lib` and `/usr/local/lib`.   These directories are specified as `-L` flags to the linker. If you are giving multiple directories, they should be separated by colons.
    * `IMPORT_PATHS=false` specifies whether to import extra path directories from the environment variables:  `PATH`, `C_INCLUDE_PATH`, `LD_LIBRARY_PATH` and `LIBRARY_PATH`. The next options can be used to specify what BLAS and/or LAPACK libraries to use (if any), overriding the default of using whatever libraries SCons chooses from searching through your path and trying to link the libraries that it finds.  The `FORCE` options can be useful if SCons finds a library before trying the one that you want, or if SCons fails in the linking step even though the library should link successfully (I'm still not sure why this happens sometimes), or if you want to compile for a library that requires different linking instructions than the ones that SCons tries. The `FORCE` options will try to test linking with the library requested, but if it fails, then it will just give a warning message.
    * `WITH_BLAS=true` specifies whether to look for and try to use a BLAS library.
    * `WITH_LAPACK=false` specifies whether to look for and try to use a LAPACK library. Note: the default here used to be `true`.  But my experience has been that the TMV code is more stable than typical LAPACK distributions, especially with regard to overflow and underflow.  And it is generally equally fast, and sometimes faster.  The only exception is finding Eigenvectors for extremely large hermitian matrices.  And even then, TMV may still be faster if you use a machine with multiple cores, since TMV seems to have better parallelization of this algorithm (if `WITH_OPENMP=true`) than many LAPACK libraries.
    * `FORCE_MKL=false` forces the use of the Intel Math Kernel library.  It requires the header file `"mkl.h"` to be found in your path. 
    * `FORCE_ACML=false` forces the use of the AMD Core Math library.   It requires the header file `"acml.h"` to be found in your path.
    * `FORCE_GOTO=false` forces the use of the GotoBlas library.  
    * `FORCE_ATLAS=false` forces the use of the ATLAS library (for BLAS).   It requires the header file `"cblas.h"` to be found in your path.
    * `FORCE_CBLAS=false` forces the use of a CBLAS library.
    * `FORCE_FBLAS=false` forces the use of a Fortran BLAS library.
    * `FORCE_CLAPACK=false` forces the use of the CLAPACk library.  It requires the CLAPACK version of the header file `"clapack.h"` to be found in your path.
    * `FORCE_ATLAS_LAPACK=false` forces the use of the LAPACK portion of the ATLAS Library.   It requires the ATLAS version of the header file `"clapack.h"` to be found in your path.
    * `FORCE_FLAPACK=false` forces the use of a Fortran LAPACK library.
    * `LIBS=''` directly specifies the library flags to use for linking if the automatic methods aren't working for you.  Because of the way SCons works, these should omit the `-l` part of the flag, since SCons will add this to what is provided. For example, to specify an alternate name for the CLAPACK library, use  `scons LIBS=lapack_LINUX`.  Multiple libraries here should be separated by whitespace and enclosed in quotes.

Finally, some miscellaneous options that you are less likely to need:
    * `STATIC=false` specifies whether to use static linkage.  Some systems have trouble with dynamic linkage of libraries.  This usually indicates that something is installed incorrectly, but it can be easier to just use static linkage when you compile as a workaround.  This flag does this for the test suite executables.
    * `WITH_SSE=true` specifies whether to use the `-msse2` flag with `icpc` compilations.  It seems like most machines that have `icpc` are able to use SSE commands.  However, I couldn't figure out a compiler flag that would turn on SSE {\em if and only if} the machine supports it.  So the default is to use the flag `-msse2`, but you can disable it by setting `WITH_SSE=false` if your machine doesn't have SSE support.
    * `XTEST=0` specifies whether to include extra tests in the test suite.  `XTEST` is treated as a bit set, with each non-zero bit turning on particular tests.  Type "`scons -h`" for more information.
    * `MEM_TEST=false` specifies whether to include extra memory tests in the library and test suite.
    * `USE_STEGR=true` specifies whether to use the LAPACK algorithm called `dstegr` (or `sstegr` for `<float>`) for symmetric eigenvector calculation.  If it is false, the divide-and-conquer algorithm, named `dstedc` (or `sstedc`) will be used instead.
    * `USE_GEQP3=true` specifies whether to use the LAPACK algorithm called `dgeqp3` (or its variants) for the strict QRP decomposition.  If it is false, the native TMV code will be used instead.
    * `SMALL_TESTS=false` specifies whether to make the smaller test suite programs: `tmvtest1a`, `tmvtest1b`, etc. 
    * `WARN=false` specifies whether to have the compiler report warning (with -Wall or something similar).
    * `NOMIX_SMALL=false` specifies whether to avoid mixing Small and regular arithmetic.   (This is automatically selected if GotoBLAS is being used.)
    * `CACHE_LIB=true` specifies whether to cache the results of the library checks.   Scons is pretty good at only recompiling what needs to be recompiled based on what options or files you have changed.  However, it is not good at detecting when changed options might change the results of a BLAS or LAPACK library check.  So if you add new paths for it to search, or even more so, if you change the names or locations of libraries on your system, then you should set `CACHE_LIB=false` to force scons to redo the BLAS and LAPACK checks each time.
    * `WITH_UPS=false` specifies whether to install TMV information for ups into the `PREFIX/ups` directory.
    * `TEST_DEPRECATED=false` specifies whether to use the old deprecated method names in the test suite.

When SCons starts up, it will look through the standard paths, along with any extra paths you have specified with the above options, to find BLAS and LAPACK libraries.  This can sometimes require a few iterations to get working correctly.   You should look at the initial output from SCons to make sure it finds the correct BLAS and LAPACK libraries that you think it should find.  Here is a sample output:

{{{
$ scons
scons: Reading SConscript files ...

Using compiler: g++-4
compiler version: 4.3.2
Debugging turned off
Checking for MKL... no
Checking for ACML... no
Checking for GotoBLAS... no
Checking for CBLAS... yes
Using CBLAS
Checking for CLAPACK... no
Checking for Fortran LAPACK... yes
Using Fortran LAPACK
scons: done reading SConscript files.
scons: Building targets ...
}}}

If a "`Checking for`..." line ends with `no`, even though you think that library is installed on your computer, then it probably means that you need to tell SCons which directories to search, in addition to the standard locations.  The most straightforward way to do this is with the parameters `EXTRA_INCLUDE_PATH` and `EXTRA_LIB_PATH`. These are described in detail above.  See also `IMPORT_ENV` and `IMPORT_PATHS`.

=== 4. Build the test suite (Optional) ===
Type:
{{{
scons test
}}}

This will make three executables called `tmvtest1`, `tmvtest2` and `tmvtest3` in the `test` directory.

Then you should run the three test suites. They should output a bunch of lines reading _Something_` passed all tests`. If one of them ends in a line that starts with `Error`,  then please post a bug report at [http://code.google.com/p/tmv-cpp/issues] about the problem including what compiler you are using, some details about your system, and what (if any) BLAS and LAPACK libraries you are linking to.

If you specify `SMALL_TESTS=true`, then the smaller test executables `tmvtest1a-d`, `tmvtest2a-c`, and `tmvtest3a-e` (where `a-d` means  four files with each of `a`, `b`, `c` and `d`) will be made instead. These perform the same tests as the larger test executables, but can be easier for some linkers.

=== 5. Install the library and header files ===
Type
{{{
scons install
}}}
(or possibly `sudo scons install` if you are installing into `/usr/local` or somewhere similar).

This will install the necessary header files into the directory `/usr/local/include` and the libraries into `/usr/local/lib`.  As mentioned above, you can also specify a different prefix with the command line option `PREFIX=`_install-dir_.  A common choice for users without `sudo` privileges is `PREFIX=~` which will install the library in `~/include` and `~/lib`.

At the end of the installation process, you should see a message similar to:
{{{
The TMV library was successfully installed.  
To link your code against the TMV library, you should use the 
link flags: 

-ltmv -llapack -lblas -lpthread -fopenmp

Or if you are using Band, Sym or SymBand matrices, use: 

-ltmv_symband -ltmv -llapack -lblas -lpthread -fopenmp

These flags (except for the optional -ltmv_symband) have been
saved in the file:

/usr/local/share/tmv-link

so you can automatically use the correct flags in a makefile
(for example) by using lines such as:

TMVLINK := $(shell cat /usr/local/share/tmv-link)
LIBS = $(TMVLINK) [... other libs ...]


scons: done building targets.
}}}
These instructions tell you what BLAS and LAPACK libraries were found on your system and  are needed for proper linkage of your code.  The linkage flags are stored in a file on your computer so that you can automatically get the linkage correct according to what options you decide to use when installing TMV.  This is especially useful on systems where a system administrator installs the library, which is then used by many users.  

You can have your makefiles read this file as described above.  Or if you are using SCons to build your software, you can similarly add the contents of the file into `env['LIBS']`. The `examples` directory has a makefile that uses the above lines (using the local `share` directory rather than the installed location).